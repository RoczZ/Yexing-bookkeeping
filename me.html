<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>我的 - 夜行记账</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .me-page {
            padding: 20px;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #000;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* 日期显示样式 */
        .header-section .date {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 12px;
        }
        
        .header-section .days-left {
            font-size: 12px;
            color: #666;
            margin-left: 8px;
        }
        
        /* 日历容器 */
        .calendar-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 12px;
            margin-bottom: 20px;
            position: relative;
        }
        
        /* 当月累计金额 */
        .month-total {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
            font-size: 12px;
            font-weight: 500;
            color: #333;
        }
        
        .month-total-amount {
            font-weight: 600;
            margin-left: 6px;
        }
        
        .month-total-amount.positive {
            color: #ff3b30;
        }
        
        .month-total-amount.negative {
            color: #34c759;
        }
        
        /* 月份导航 */
        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .month-nav button {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f5f5f5;
            color: #333;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .month-nav button:hover {
            border-color: #000;
            background-color: #f0f0f0;
        }
        
        .current-month {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        /* 星期标题 */
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-bottom: 6px;
        }
        
        .weekday {
            text-align: center;
            font-size: 10px;
            font-weight: 500;
            color: #666;
            padding: 6px 0;
        }
        
        /* 日历格子 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #f9f9f9;
            padding: 4px;
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover {
            border-color: #000;
            background-color: #f0f0f0;
        }
        
        .calendar-day.other-month {
            background-color: #f0f0f0;
            color: #999;
        }
        
        .calendar-day.today {
            border-color: #000;
            background-color: #f0f0f0;
            font-weight: 500;
        }
        
        .day-number {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 1px;
        }
        
        .day-amount {
            font-size: 9px;
            font-weight: 600;
        }
        
        .day-amount.positive {
            color: #ff3b30;
        }
        
        .day-amount.negative {
            color: #34c759;
        }
        
        .empty-day {
            aspect-ratio: 1;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 主内容区域 -->
        <div class="main-content me-page">
            <h1 class="page-title">存钱助手</h1>
            
            <!-- 工资和存款设置模块 -->
            <div class="finance-settings" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); padding: 20px; margin-bottom: 20px;">
                <!-- 月均工资 -->
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 13px; color: #333; width: 80px;">月均工资：</div>
                    <input type="text" id="monthlySalary" placeholder="请输入" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; text-align: center;" disabled>
                    <button onclick="toggleSalaryEdit()" id="salaryButton" style="margin-left: 8px; padding: 4px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5; color: #333; font-size: 12px; cursor: pointer;">填写</button>
                    <button onclick="clearSalary()" id="salaryClearButton" style="margin-left: 4px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; color: #666; font-size: 10px; cursor: pointer; display: none;">清除</button>
                </div>
                
                <!-- 月均房租 -->
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 13px; color: #333; width: 80px;">月均房租：</div>
                    <input type="text" id="monthlyRent" placeholder="请输入" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; text-align: center;" disabled>
                    <button onclick="toggleRentEdit()" id="rentButton" style="margin-left: 8px; padding: 4px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5; color: #333; font-size: 12px; cursor: pointer;">填写</button>
                    <button onclick="clearRent()" id="rentClearButton" style="margin-left: 4px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; color: #666; font-size: 10px; cursor: pointer; display: none;">清除</button>
                </div>
                
                <!-- 计划存款 -->
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 13px; color: #333; width: 80px;">计划存款：</div>
                    <input type="text" id="monthlySavings" placeholder="请输入" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; text-align: center;" disabled>
                    <button onclick="toggleSavingsEdit()" id="savingsButton" style="margin-left: 8px; padding: 4px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5; color: #333; font-size: 12px; cursor: pointer;">填写</button>
                    <button onclick="clearSavings()" id="savingsClearButton" style="margin-left: 4px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; color: #666; font-size: 10px; cursor: pointer; display: none;">清除</button>
                </div>
                
                <!-- 每天可消费额度 -->
                <div style="padding-top: 12px; border-top: 1px solid #f0f0f0;">
                    <div style="font-size: 12px; color: #333;">
                        当月额度：<span style="font-size: 14px; font-weight: 600; color: #000; margin-left: 4px; margin-right: 20px;" id="totalBudget">0元</span>
                        每天额度：<span style="font-size: 14px; font-weight: 600; color: #000; margin-left: 4px;" id="dailyBudget">0元</span>
                    </div>
                </div>
            </div>
            
            <!-- 日历容器 -->
            <div class="calendar-container">
                <!-- 月份导航 -->
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">← 上月</button>
                    <div class="current-month" id="currentMonth">2026年1月</div>
                    <button onclick="changeMonth(1)">下月 →</button>
                </div>
                
                <!-- 星期标题 -->
                <div class="weekdays">
                    <div class="weekday">日</div>
                    <div class="weekday">一</div>
                    <div class="weekday">二</div>
                    <div class="weekday">三</div>
                    <div class="weekday">四</div>
                    <div class="weekday">五</div>
                    <div class="weekday">六</div>
                </div>
                
                <!-- 日历格子 -->
                <div class="calendar-grid" id="calendarGrid">
                    <!-- 日历格子将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 底部导航栏 -->
        <nav class="bottom-nav">
            <a href="index.html" class="bottom-nav-item">首页</a>
            <a href="records.html" class="bottom-nav-item">账单</a>
            <a href="me.html" class="bottom-nav-item active">我的</a>
        </nav>
    </div>
    
    <script>
        let currentDate = new Date();
        
        // 切换工资编辑状态
        function toggleSalaryEdit() {
            const salaryInput = document.getElementById('monthlySalary');
            const salaryButton = document.getElementById('salaryButton');
            const salaryClearButton = document.getElementById('salaryClearButton');
            
            if (salaryInput.disabled) {
                // 启用输入框
                salaryInput.disabled = false;
                salaryInput.focus();
                salaryButton.textContent = '确认';
            } else {
                // 保存数据
                const salary = parseInt(salaryInput.value);
                if (!isNaN(salary) && salary > 0) {
                    localStorage.setItem('monthlySalary', salary);
                    updateDailyBudget();
                    alert('月均工资已保存');
                    // 禁用输入框
                    salaryInput.disabled = true;
                    salaryButton.textContent = '修改';
                    // 显示清除按钮
                    salaryClearButton.style.display = 'inline-block';
                } else {
                    alert('请输入有效的月均工资');
                }
            }
        }
        
        // 切换房租编辑状态
        function toggleRentEdit() {
            const rentInput = document.getElementById('monthlyRent');
            const rentButton = document.getElementById('rentButton');
            const rentClearButton = document.getElementById('rentClearButton');
            
            if (rentInput.disabled) {
                // 启用输入框
                rentInput.disabled = false;
                rentInput.focus();
                rentButton.textContent = '确认';
            } else {
                // 保存数据
                const rent = parseInt(rentInput.value);
                if (!isNaN(rent) && rent >= 0) {
                    localStorage.setItem('monthlyRent', rent);
                    updateDailyBudget();
                    alert('月均房租已保存');
                    // 禁用输入框
                    rentInput.disabled = true;
                    rentButton.textContent = '修改';
                    // 显示清除按钮
                    rentClearButton.style.display = 'inline-block';
                } else {
                    alert('请输入有效的月均房租');
                }
            }
        }
        
        // 切换存款编辑状态
        function toggleSavingsEdit() {
            const savingsInput = document.getElementById('monthlySavings');
            const savingsButton = document.getElementById('savingsButton');
            const savingsClearButton = document.getElementById('savingsClearButton');
            
            if (savingsInput.disabled) {
                // 启用输入框
                savingsInput.disabled = false;
                savingsInput.focus();
                savingsButton.textContent = '确认';
            } else {
                // 保存数据
                const savings = parseInt(savingsInput.value);
                if (!isNaN(savings) && savings >= 0) {
                    localStorage.setItem('monthlySavings', savings);
                    updateDailyBudget();
                    alert('计划存款已保存');
                    // 禁用输入框
                    savingsInput.disabled = true;
                    savingsButton.textContent = '修改';
                    // 显示清除按钮
                    savingsClearButton.style.display = 'inline-block';
                } else {
                    alert('请输入有效的计划存款');
                }
            }
        }
        
        // 清除工资数据
        function clearSalary() {
            const salaryInput = document.getElementById('monthlySalary');
            const salaryButton = document.getElementById('salaryButton');
            const salaryClearButton = document.getElementById('salaryClearButton');
            
            localStorage.removeItem('monthlySalary');
            salaryInput.value = '';
            updateDailyBudget();
            // 更新按钮文本
            salaryButton.textContent = '填写';
            // 隐藏清除按钮
            salaryClearButton.style.display = 'none';
            alert('月均工资数据已清除');
        }
        
        // 清除房租数据
        function clearRent() {
            const rentInput = document.getElementById('monthlyRent');
            const rentButton = document.getElementById('rentButton');
            const rentClearButton = document.getElementById('rentClearButton');
            
            localStorage.removeItem('monthlyRent');
            rentInput.value = '';
            updateDailyBudget();
            // 更新按钮文本
            rentButton.textContent = '填写';
            // 隐藏清除按钮
            rentClearButton.style.display = 'none';
            alert('月均房租数据已清除');
        }
        
        // 清除存款数据
        function clearSavings() {
            const savingsInput = document.getElementById('monthlySavings');
            const savingsButton = document.getElementById('savingsButton');
            const savingsClearButton = document.getElementById('savingsClearButton');
            
            localStorage.removeItem('monthlySavings');
            savingsInput.value = '';
            updateDailyBudget();
            // 更新按钮文本
            savingsButton.textContent = '填写';
            // 隐藏清除按钮
            savingsClearButton.style.display = 'none';
            alert('计划存款数据已清除');
        }
        
        // 更新消费额度
        function updateDailyBudget() {
            const monthlySalary = parseInt(localStorage.getItem('monthlySalary') || '0');
            const monthlyRent = parseInt(localStorage.getItem('monthlyRent') || '0');
            const monthlySavings = parseInt(localStorage.getItem('monthlySavings') || '0');
            
            // 计算消费总额度
            let totalBudget = 0;
            if (monthlySalary > (monthlyRent + monthlySavings)) {
                totalBudget = monthlySalary - monthlyRent - monthlySavings;
            }
            
            // 获取当月天数
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // 计算每天可消费额度
            let dailyBudget = 0;
            if (totalBudget > 0) {
                dailyBudget = Math.floor(totalBudget / daysInMonth);
            }
            
            // 更新显示
            document.getElementById('totalBudget').textContent = `${totalBudget}元`;
            document.getElementById('dailyBudget').textContent = `${dailyBudget}元`;
        }
        
        // 初始化工资和存款设置
        function initFinanceSettings() {
            // 从localStorage读取数据
            const monthlySalary = localStorage.getItem('monthlySalary') || '';
            const monthlyRent = localStorage.getItem('monthlyRent') || '';
            const monthlySavings = localStorage.getItem('monthlySavings') || '';
            
            // 填充输入框
            document.getElementById('monthlySalary').value = monthlySalary;
            document.getElementById('monthlyRent').value = monthlyRent;
            document.getElementById('monthlySavings').value = monthlySavings;
            
            // 更新工资按钮和清除按钮
            if (monthlySalary) {
                document.getElementById('salaryButton').textContent = '修改';
                document.getElementById('salaryClearButton').style.display = 'inline-block';
            } else {
                document.getElementById('salaryButton').textContent = '填写';
                document.getElementById('salaryClearButton').style.display = 'none';
            }
            
            // 更新房租按钮和清除按钮
            if (monthlyRent) {
                document.getElementById('rentButton').textContent = '修改';
                document.getElementById('rentClearButton').style.display = 'inline-block';
            } else {
                document.getElementById('rentButton').textContent = '填写';
                document.getElementById('rentClearButton').style.display = 'none';
            }
            
            // 更新存款按钮和清除按钮
            if (monthlySavings) {
                document.getElementById('savingsButton').textContent = '修改';
                document.getElementById('savingsClearButton').style.display = 'inline-block';
            } else {
                document.getElementById('savingsButton').textContent = '填写';
                document.getElementById('savingsClearButton').style.display = 'none';
            }
            
            // 更新每天可消费额度
            updateDailyBudget();
        }
        
        // 初始化日历
        function initCalendar() {
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
        
        // 切换月份
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
        
        // 计算当天的收支合计
        function calculateDayAmount(year, month, day) {
            const records = JSON.parse(localStorage.getItem('financeRecords') || '[]');
            const targetDate = `${year}年${month.toString().padStart(2, '0')}月${day.toString().padStart(2, '0')}日`;
            
            return records.reduce((total, record) => {
                if (record.date === targetDate) {
                    if (record.category === 'income') {
                        return total + record.amount;
                    } else {
                        return total - record.amount;
                    }
                }
                return total;
            }, 0);
        }
        
        // 计算当月累计金额
        function calculateMonthTotal(year, month) {
            const records = JSON.parse(localStorage.getItem('financeRecords') || '[]');
            const targetMonth = `${year}年${month.toString().padStart(2, '0')}月`;
            
            return records.reduce((total, record) => {
                if (record.date.startsWith(targetMonth)) {
                    if (record.category === 'income') {
                        return total + record.amount;
                    } else {
                        return total - record.amount;
                    }
                }
                return total;
            }, 0);
        }
        
        // 显示当月累计金额
        function displayMonthTotal(year, month) {
            let total = calculateMonthTotal(year, month);
            const calendarContainer = document.querySelector('.calendar-container');
            
            // 移除旧的累计金额元素
            const oldTotalElement = document.querySelector('.month-total');
            if (oldTotalElement) {
                oldTotalElement.remove();
            }
            
            // 获取当月额度（从上面的设置中获取）
            const monthlySalary = parseInt(localStorage.getItem('monthlySalary') || '0');
            const monthlyRent = parseInt(localStorage.getItem('monthlyRent') || '0');
            const monthlySavings = parseInt(localStorage.getItem('monthlySavings') || '0');
            
            let totalBudget = 0;
            if (monthlySalary > (monthlyRent + monthlySavings)) {
                totalBudget = monthlySalary - monthlyRent - monthlySavings;
            }
            
            // 当月累计金额向上取整，对于负数（支出），向上取整是指向更小的方向取整
            if (total < 0) {
                total = Math.floor(total);
            } else {
                total = Math.ceil(total);
            }
            
            // 计算当月剩余额度：剩余额度 = 当月累计金额 - 计划存款
            // 按照用户要求的计算公式
            let remaining = total - monthlySavings;
            
            const totalElement = document.createElement('div');
            totalElement.className = 'month-total';
            
            let totalClass = '';
            let totalText = '';
            let remainingClass = '';
            let remainingText = '';
            
            // 格式化金额显示 - 整数
            function formatAmount(amount) {
                return Math.abs(amount).toString();
            }
            
            if (total > 0) {
                totalClass = 'positive';
                totalText = `+${formatAmount(total)}`;
            } else if (total < 0) {
                totalClass = 'negative';
                totalText = `-${formatAmount(total)}`;
            } else {
                totalText = '0';
            }
            
            if (remaining > 0) {
                remainingClass = 'positive';
                remainingText = `+${formatAmount(remaining)}`;
            } else if (remaining < 0) {
                remainingClass = 'negative';
                remainingText = `-${formatAmount(remaining)}`;
            } else {
                remainingText = '0';
            }
            
            totalElement.innerHTML = `
                当月累计金额：
                <span class="month-total-amount ${totalClass}">${totalText}</span>
                <span style="margin-left: 20px;">当月剩余额度：
                <span class="month-total-amount ${remainingClass}">${remainingText}</span>
                </span>
            `;
            
            // 添加新的累计金额元素
            calendarContainer.appendChild(totalElement);
        }
        
        // 生成日历
        function generateCalendar(year, month) {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            
            // 更新当前月份显示
            currentMonthElement.textContent = `${year}年${month + 1}月`;
            
            // 获取当月第一天
            const firstDay = new Date(year, month, 1);
            // 获取当月最后一天
            const lastDay = new Date(year, month + 1, 0);
            // 获取当月第一天是星期几
            const startDayOfWeek = firstDay.getDay();
            // 获取当月天数
            const daysInMonth = lastDay.getDate();
            
            // 获取上个月最后一天
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            // 清空日历格子
            calendarGrid.innerHTML = '';
            
            // 添加上个月的日期
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `
                    <div class="day-number">${prevMonthLastDay - i}</div>
                    <div class="day-amount"></div>
                `;
                calendarGrid.appendChild(dayElement);
            }
            
            // 添加当月的日期
            for (let i = 1; i <= daysInMonth; i++) {
                const dayElement = document.createElement('div');
                const isToday = i === new Date().getDate() && 
                               month === new Date().getMonth() && 
                               year === new Date().getFullYear();
                
                dayElement.className = `calendar-day ${isToday ? 'today' : ''}`;
                
                // 计算当天的收支合计
                let dayAmount = calculateDayAmount(year, month + 1, i);
                
                // 所有数值向上取整，确保负数也正确向上取整（如-4.5显示-5）
                if (dayAmount < 0) {
                    dayAmount = Math.floor(dayAmount);
                } else {
                    dayAmount = Math.ceil(dayAmount);
                }
                
                let amountClass = '';
                let amountText = '';
                
                // 格式化金额显示
                function formatAmount(amount) {
                    const absAmount = Math.abs(amount);
                    if (absAmount >= 10000) {
                        return (absAmount / 10000).toFixed(1) + 'W';
                    } else if (absAmount >= 1000) {
                        return (absAmount / 1000).toFixed(1) + 'K';
                    } else {
                        return absAmount.toString();
                    }
                }
                
                if (dayAmount > 0) {
                    amountClass = 'positive';
                    amountText = `+${formatAmount(dayAmount)}`;
                } else if (dayAmount < 0) {
                    amountClass = 'negative';
                    amountText = `-${formatAmount(dayAmount)}`;
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${i}</div>
                    <div class="day-amount ${amountClass}">${amountText}</div>
                `;
                calendarGrid.appendChild(dayElement);
            }
            
            // 计算需要添加的下个月日期数量
            const remainingCells = 42 - (startDayOfWeek + daysInMonth); // 42是6行7列的总格子数
            
            // 添加下个月的日期
            for (let i = 1; i <= remainingCells; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `
                    <div class="day-number">${i}</div>
                    <div class="day-amount"></div>
                `;
                calendarGrid.appendChild(dayElement);
            }
            
            // 显示当月累计金额
            displayMonthTotal(year, month + 1);
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            initFinanceSettings();
            initCalendar();
            
            // 为底部导航栏添加震动效果
            addVibrationEffect();
        };
        
        // 添加震动效果
        function addVibrationEffect() {
            const navItems = document.querySelectorAll('.bottom-nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // 检查设备是否支持震动
                    if (navigator.vibrate) {
                        navigator.vibrate(100); // 震动100毫秒
                    }
                    // 继续默认的点击行为（页面跳转）
                });
            });
        }
    </script>
</body>
</html>