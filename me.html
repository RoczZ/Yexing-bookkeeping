<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>我的 - 夜行记账</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .me-page {
            padding: 20px;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #000;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* 日历容器 */
        .calendar-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 12px;
            margin-bottom: 20px;
            position: relative;
        }
        
        /* 当月累计金额 */
        .month-total {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
            font-size: 12px;
            font-weight: 500;
            color: #333;
        }
        
        .month-total-amount {
            font-weight: 600;
            margin-left: 6px;
        }
        
        .month-total-amount.positive {
            color: #ff3b30;
        }
        
        .month-total-amount.negative {
            color: #34c759;
        }
        
        /* 月份导航 */
        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .month-nav button {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f5f5f5;
            color: #333;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .month-nav button:hover {
            border-color: #000;
            background-color: #f0f0f0;
        }
        
        .current-month {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        /* 星期标题 */
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-bottom: 6px;
        }
        
        .weekday {
            text-align: center;
            font-size: 10px;
            font-weight: 500;
            color: #666;
            padding: 6px 0;
        }
        
        /* 日历格子 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #f9f9f9;
            padding: 4px;
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover {
            border-color: #000;
            background-color: #f0f0f0;
        }
        
        .calendar-day.other-month {
            background-color: #f0f0f0;
            color: #999;
        }
        
        .calendar-day.today {
            border-color: #000;
            background-color: #f0f0f0;
            font-weight: 500;
        }
        
        .day-number {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 1px;
        }
        
        .day-amount {
            font-size: 9px;
            font-weight: 600;
        }
        
        .day-amount.positive {
            color: #ff3b30;
        }
        
        .day-amount.negative {
            color: #34c759;
        }
        
        .empty-day {
            aspect-ratio: 1;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 主内容区域 -->
        <div class="main-content me-page">
            <h1 class="page-title">存钱计划</h1>
            
            <!-- 日历容器 -->
            <div class="calendar-container">
                <!-- 月份导航 -->
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">← 上月</button>
                    <div class="current-month" id="currentMonth">2026年1月</div>
                    <button onclick="changeMonth(1)">下月 →</button>
                </div>
                
                <!-- 星期标题 -->
                <div class="weekdays">
                    <div class="weekday">日</div>
                    <div class="weekday">一</div>
                    <div class="weekday">二</div>
                    <div class="weekday">三</div>
                    <div class="weekday">四</div>
                    <div class="weekday">五</div>
                    <div class="weekday">六</div>
                </div>
                
                <!-- 日历格子 -->
                <div class="calendar-grid" id="calendarGrid">
                    <!-- 日历格子将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 底部导航栏 -->
        <nav class="bottom-nav">
            <a href="index.html" class="bottom-nav-item">首页</a>
            <a href="records.html" class="bottom-nav-item">账单</a>
            <a href="me.html" class="bottom-nav-item active">我的</a>
        </nav>
    </div>
    
    <script>
        let currentDate = new Date();
        
        // 初始化日历
        function initCalendar() {
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
        
        // 切换月份
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
        
        // 计算当天的收支合计
        function calculateDayAmount(year, month, day) {
            const records = JSON.parse(localStorage.getItem('financeRecords') || '[]');
            const targetDate = `${year}年${month.toString().padStart(2, '0')}月${day.toString().padStart(2, '0')}日`;
            
            return records.reduce((total, record) => {
                if (record.date === targetDate) {
                    if (record.category === 'income') {
                        return total + record.amount;
                    } else {
                        return total - record.amount;
                    }
                }
                return total;
            }, 0);
        }
        
        // 计算当月累计金额
        function calculateMonthTotal(year, month) {
            const records = JSON.parse(localStorage.getItem('financeRecords') || '[]');
            const targetMonth = `${year}年${month.toString().padStart(2, '0')}月`;
            
            return records.reduce((total, record) => {
                if (record.date.startsWith(targetMonth)) {
                    if (record.category === 'income') {
                        return total + record.amount;
                    } else {
                        return total - record.amount;
                    }
                }
                return total;
            }, 0);
        }
        
        // 显示当月累计金额
        function displayMonthTotal(year, month) {
            const total = calculateMonthTotal(year, month);
            const calendarContainer = document.querySelector('.calendar-container');
            
            // 移除旧的累计金额元素
            const oldTotalElement = document.querySelector('.month-total');
            if (oldTotalElement) {
                oldTotalElement.remove();
            }
            
            const totalElement = document.createElement('div');
            totalElement.className = 'month-total';
            
            let totalClass = '';
            let totalText = '';
            
            // 格式化金额显示 - 累计金额显示原始数值
            function formatAmount(amount) {
                return Math.abs(amount).toString();
            }
            
            if (total > 0) {
                totalClass = 'positive';
                totalText = `+${formatAmount(total)}`;
            } else if (total < 0) {
                totalClass = 'negative';
                totalText = `-${formatAmount(total)}`;
            } else {
                totalText = '0';
            }
            
            totalElement.innerHTML = `
                当月累计金额：
                <span class="month-total-amount ${totalClass}">${totalText}</span>
            `;
            
            // 添加新的累计金额元素
            calendarContainer.appendChild(totalElement);
        }
        
        // 生成日历
        function generateCalendar(year, month) {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            
            // 更新当前月份显示
            currentMonthElement.textContent = `${year}年${month + 1}月`;
            
            // 获取当月第一天
            const firstDay = new Date(year, month, 1);
            // 获取当月最后一天
            const lastDay = new Date(year, month + 1, 0);
            // 获取当月第一天是星期几
            const startDayOfWeek = firstDay.getDay();
            // 获取当月天数
            const daysInMonth = lastDay.getDate();
            
            // 获取上个月最后一天
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            // 清空日历格子
            calendarGrid.innerHTML = '';
            
            // 添加上个月的日期
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `
                    <div class="day-number">${prevMonthLastDay - i}</div>
                    <div class="day-amount"></div>
                `;
                calendarGrid.appendChild(dayElement);
            }
            
            // 添加当月的日期
            for (let i = 1; i <= daysInMonth; i++) {
                const dayElement = document.createElement('div');
                const isToday = i === new Date().getDate() && 
                               month === new Date().getMonth() && 
                               year === new Date().getFullYear();
                
                dayElement.className = `calendar-day ${isToday ? 'today' : ''}`;
                
                // 计算当天的收支合计
                const dayAmount = calculateDayAmount(year, month + 1, i);
                let amountClass = '';
                let amountText = '';
                
                // 格式化金额显示
                function formatAmount(amount) {
                    const absAmount = Math.abs(amount);
                    if (absAmount >= 10000) {
                        return (absAmount / 10000).toFixed(1) + 'W';
                    } else if (absAmount >= 1000) {
                        return (absAmount / 1000).toFixed(1) + 'K';
                    } else {
                        return absAmount.toString();
                    }
                }
                
                if (dayAmount > 0) {
                    amountClass = 'positive';
                    amountText = `+${formatAmount(dayAmount)}`;
                } else if (dayAmount < 0) {
                    amountClass = 'negative';
                    amountText = `-${formatAmount(dayAmount)}`;
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${i}</div>
                    <div class="day-amount ${amountClass}">${amountText}</div>
                `;
                calendarGrid.appendChild(dayElement);
            }
            
            // 计算需要添加的下个月日期数量
            const remainingCells = 42 - (startDayOfWeek + daysInMonth); // 42是6行7列的总格子数
            
            // 添加下个月的日期
            for (let i = 1; i <= remainingCells; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `
                    <div class="day-number">${i}</div>
                    <div class="day-amount"></div>
                `;
                calendarGrid.appendChild(dayElement);
            }
            
            // 显示当月累计金额
            displayMonthTotal(year, month + 1);
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            initCalendar();
            
            // 为底部导航栏添加震动效果
            addVibrationEffect();
        };
        
        // 添加震动效果
        function addVibrationEffect() {
            const navItems = document.querySelectorAll('.bottom-nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // 检查设备是否支持震动
                    if (navigator.vibrate) {
                        navigator.vibrate(100); // 震动100毫秒
                    }
                    // 继续默认的点击行为（页面跳转）
                });
            });
        }
    </script>
</body>
</html>